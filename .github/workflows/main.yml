name: Main - CI/CD

on:
  push:
    branches: [main]

jobs:
  service-readiness:
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.check.outputs.ready }}
    steps:
      - uses: actions/checkout@v4
      - id: check
        run: |
          if [ -f pom.xml ] && [ -f Dockerfile ]; then
            echo "ready=true" >> "$GITHUB_OUTPUT"
          else
            echo "ready=false" >> "$GITHUB_OUTPUT"
          fi

  build-and-test:
    needs: service-readiness
    if: ${{ needs.service-readiness.outputs.ready == 'true' }}
    permissions:
      contents: read
      packages: read
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-java-ci.yml@main
    with:
      java_version: '21'
      skip_checkstyle: true
      build_command: 'mvn -B -ntp -U clean verify'
      upload_jacoco_reports: true
      jacoco_artifact_name: 'jacoco-reports-${{ github.run_id }}'
      jacoco_report_path: '**/target/site/jacoco/jacoco.xml'
    secrets: inherit

  sonar:
    needs: [service-readiness, build-and-test]
    if: ${{ needs.service-readiness.outputs.ready == 'true' }}
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-sonar-java.yml@main
    with:
      java_version: '21'
      sonar_org: 'fiap-soat-grupo36'
      sonar_project_key: 'fiap-soat-grupo36_work-order-service'
      maven_skip_tests: true
      download_jacoco_artifacts: true
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  docker:
    needs: [service-readiness, build-and-test, sonar]
    if: ${{ needs.service-readiness.outputs.ready == 'true' }}
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-dockerhub.yml@main
    with:
      modules: '["work-order-service"]'
      dockerfile_pattern: './Dockerfile'
      registry_namespace: 'fiapsoatgrupo36'
      tag_strategy: 'custom'
      custom_tags: '["latest", "stable", "${{ github.sha }}"]'
      push_images: true
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  service-not-ready:
    needs: service-readiness
    if: ${{ needs.service-readiness.outputs.ready != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "Repository does not have pom.xml and Dockerfile yet. Skipping CI jobs."
