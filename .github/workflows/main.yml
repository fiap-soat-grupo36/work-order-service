name: Main - CI/CD & Deploy to Production

on:
  push:
    branches: [main]

jobs:
  # 1. Build, Lint e Testes Unit√°rios
  build-and-test:
    permissions:
      contents: read
      packages: read
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-java-ci.yml@main
    with:
      java_version: '21'
      skip_checkstyle: true
      build_command: 'mvn -B -ntp -U clean verify'
      upload_jacoco_reports: true
      jacoco_artifact_name: 'jacoco-reports-${{ github.run_id }}'
      jacoco_report_path: '**/target/site/jacoco/jacoco.xml'
    secrets: inherit

  # 2. SonarCloud - Cobertura de Testes
  sonar:
    needs: build-and-test
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-sonar-java.yml@main
    with:
      java_version: '21'
      sonar_org: 'fiap-soat-grupo36'
      sonar_project_key: 'work-order-service'
      maven_skip_tests: true
      download_jacoco_artifacts: true
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # 3. Docker Build & Push
  docker:
    needs: [build-and-test, sonar]
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-dockerhub.yml@main
    with:
      modules: '["work-order-service"]'
      registry_namespace: 'fiapsoatgrupo36'
      tag_strategy: 'custom'
      custom_tags: '["latest", "stable", "${{ github.sha }}"]'
      push_images: true
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  # 4. Deploy to Production
  deploy-production:
    needs: docker
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-terraform.yml@main
    with:
      workspace: production
      environment: prod
      working_directory: ./infra
      auto_apply: true
      tfvars_file: 'environments/prod.tfvars'
      terraform_vars: |
        {
          "environment": "prod"
        }
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.PROD_AWS_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.PROD_AWS_SECRET_KEY }}
