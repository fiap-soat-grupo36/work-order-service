name: Feature Branch - CI & Terraform Validation

on:
  push:
    branches: [feature/*]

jobs:
  build-and-test:
    permissions:
      contents: read
      packages: read
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-java-ci.yml@main
    with:
      java_version: '21'
      skip_checkstyle: true
      build_command: 'mvn -B -ntp -U clean test'
      package_command: 'mvn -B -ntp -U package -DskipTests'
      upload_jacoco_reports: false
    secrets: inherit

  #verify-infrastructure:
  #  uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-terraform.yml@main
  #  with:
  #    workspace: dev
  #    environment: dev
  #    working_directory: ./infra
  #    auto_apply: false
  #    localstack_pod: fiap
  #  secrets:
  #    LOCALSTACK_AUTH_TOKEN: ${{ secrets.LOCALSTACK_AUTH_TOKEN }}

  create-pr:
    permissions:
      contents: read
      pull-requests: write
    needs: build-and-test #, terraform-validation]
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-create-pr.yml@main
    with:
      base: develop
      title: "âœ¨ Feature: ${{ github.event.head_commit.message }}"
      body: |
        ## ðŸš€ Feature Ready for Review
        
        **Branch:** `${{ github.ref_name }}`
        **Commit:** `${{ github.sha }}`
        **Author:** @${{ github.actor }}
        
        ### âœ… CI Status
        - âœ… Lint passed
        - âœ… Unit tests passed
        - âœ… Build successful
        - âœ… Terraform validate passed
        - âœ… Terraform plan successful (dev)
        
        Ready for code review and merge to develop!
      labels: '["feature", "auto-pr", "ci-passed"]'
      reviewers: '["tech-lead"]'
