name: Feature Branch - CI & Terraform Validation

on:
  push:
    branches: [feature/*]

jobs:
  # 1. Build, Lint e Testes UnitÃ¡rios
  build-and-test:
    permissions:
      contents: read
      packages: read
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-java-ci.yml@main
    with:
      java_version: '21'
      skip_checkstyle: true
      build_command: 'mvn -B -ntp -U clean test'
      package_command: 'mvn -B -ntp -U package -DskipTests'
      upload_jacoco_reports: false
    secrets: inherit

  # 2. Terraform Validate e Plan
  terraform-validation:
    needs: build-and-test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./infra
    steps:
      - uses: actions/checkout@v4
      
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Terraform Format Check
        run: terraform fmt -check -recursive
      
      - name: Terraform Init
        run: terraform init -backend=false
      
      - name: Terraform Validate
        run: terraform validate
      
      - name: Terraform Plan (Dev Workspace)
        run: |
          terraform workspace select dev || terraform workspace new dev
          terraform plan -var-file=environments/dev.tfvars -out=tfplan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.DEV_AWS_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.DEV_AWS_SECRET_KEY }}

  # 3. Criar PR AutomÃ¡tico para Develop
  create-pr:
    needs: [build-and-test, terraform-validation]
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-create-pr.yml@main
    with:
      base: develop
      title: "âœ¨ Feature: ${{ github.event.head_commit.message }}"
      body: |
        ## ðŸš€ Feature Ready for Review
        
        **Branch:** `${{ github.ref_name }}`
        **Commit:** `${{ github.sha }}`
        **Author:** @${{ github.actor }}
        
        ### âœ… CI Status
        - âœ… Lint passed
        - âœ… Unit tests passed
        - âœ… Build successful
        - âœ… Terraform validate passed
        - âœ… Terraform plan successful (dev)
        
        Ready for code review and merge to develop!
      labels: '["feature", "auto-pr", "ci-passed"]'
      reviewers: '["tech-lead"]'
